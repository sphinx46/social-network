server:
  port: 8082

spring:
  application:
    name: api-gateway

  
  data:
    redis:
      host: ${REDIS_HOST:redis}
      port: ${REDIS_PORT:6379}
      timeout: 2000ms
      lettuce:
        pool:
          max-active: 8
          max-idle: 8
          min-idle: 0
  
  session:
    store-type: redis
    redis:
      namespace: spring:session:api-gateway
    timeout: 30m
  
  cloud:
    gateway:
      routes:
        - id: user-profile-service-auth
          uri: lb://user-profile-service
          predicates:
            - Path=/api/profile/me
          filters:
            - name: UserContextFilter
              args:
                enabled: true
            - TokenRelay=
            - RewritePath=/api/profile/me, /api/user-profile/profile/me
          metadata:
            response-timeout: 5000
            connect-timeout: 2000
        
        - id: user-profile-service-public
          uri: lb://user-profile-service
          predicates:
            - Path=/api/profile/{keycloakUserId}
            - Method=GET
          filters:
            - RewritePath=/api/profile/(?<keycloakUserId>.*), /api/user-profile/profile/${keycloakUserId}
          metadata:
            response-timeout: 5000
            connect-timeout: 2000
        
        - id: keycloak-auth
          uri: http://keycloak:8080
          predicates:
            - Path=/auth/**
          filters:
            - RewritePath=/auth/(?<segment>.*), /${segment}
            - AddRequestHeader=X-Gateway, api-gateway
        
        - id: eureka-dashboard
          uri: http://eureka-server:8761
          predicates:
            - Path=/eureka/**
          filters:
            - AddRequestHeader=X-Gateway, api-gateway
      
      server:
        webflux:
          discovery:
            locator:
              enabled: true
              lower-case-service-id: true
              url-expression: "'http://'+serviceId"
          globalcors:
            cors-configurations:
              '[/**]':
                allowedOriginPatterns: ${CORS_ALLOWED_ORIGINS:http://localhost:*,http://127.0.0.1:*}
                allowedMethods:
                  - GET
                  - POST
                  - PUT
                  - DELETE
                  - PATCH
                  - OPTIONS
                allowedHeaders:
                  - Content-Type
                  - Authorization
                  - X-Requested-With
                  - X-User-Id
                  - X-Username
                  - X-Email
                  - X-First-Name
                  - X-Last-Name
                allowCredentials: true
                maxAge: 3600
      
      default-filters:
        - DedupeResponseHeader=Access-Control-Allow-Credentials Access-Control-Allow-Origin
        - AddResponseHeader=X-Gateway-Version, 1.0.0
  
  security:
    oauth2:
      client:
        provider:
          keycloak:
            jwk-set-uri: http://keycloak:8080/realms/social-network/protocol/openid-connect/certs
            authorization-uri: http://localhost:8080/realms/social-network/protocol/openid-connect/auth
            token-uri: http://keycloak:8080/realms/social-network/protocol/openid-connect/token
            user-info-uri: http://keycloak:8080/realms/social-network/protocol/openid-connect/userinfo
            user-name-attribute: preferred_username
        registration:
          keycloak:
            provider: keycloak
            client-id: ${KEYCLOAK_CLIENT_ID:api-gateway}
            client-secret: ${KEYCLOAK_CLIENT_SECRET}
            authorization-grant-type: authorization_code
            scope:
              - openid
              - email
              - profile
              - roles
            redirect-uri: "{baseUrl}/login/oauth2/code/{registrationId}"

app:
  logout:
    redirect-uri: ${LOGOUT_REDIRECT_URI:http://localhost:8082/}
  gateway:
      signature-secret: ${SIGNATURE_KEY_SECRET}

eureka:
  client:
    service-url:
      defaultZone: ${EUREKA_CLIENT_SERVICE_URL_DEFAULT_ZONE:http://eureka-server:8761/eureka/}
    register-with-eureka: true
    fetch-registry: true
    registry-fetch-interval-seconds: 5
    initial-instance-info-replication-interval-seconds: 5
    healthcheck:
      enabled: true
  instance:
    hostname: ${HOSTNAME:api-gateway}
    prefer-ip-address: false
    lease-renewal-interval-in-seconds: 5
    lease-expiration-duration-in-seconds: 10
    health-check-url-path: /actuator/health
    status-page-url-path: /actuator/info

management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus,gateway
      base-path: /actuator
  endpoint:
    health:
      show-details: ${HEALTH_SHOW_DETAILS:when-authorized}
      probes:
        enabled: true
  prometheus:
    metrics:
      export:
        enabled: true
  health:
    circuitbreakers:
      enabled: true
    livenessstate:
      enabled: true
    readinessstate:
      enabled: true

resilience4j:
  circuitbreaker:
    configs:
      default:
        registerHealthIndicator: true
        slidingWindowSize: 10
        minimumNumberOfCalls: 5
        permittedNumberOfCallsInHalfOpenState: 3
        automaticTransitionFromOpenToHalfOpenEnabled: true
        waitDurationInOpenState: 10s
        failureRateThreshold: 50
        eventConsumerBufferSize: 10
  timelimiter:
    configs:
      default:
        timeoutDuration: 5s
        cancelRunningFuture: true

logging:
  level:
    root: INFO
    ru.vsu.cs.social_network.api_gateway: ${LOG_LEVEL:INFO}
    org.springframework.cloud.gateway: INFO
    org.springframework.security: INFO
    org.springframework.web: INFO
    org.springframework.session: INFO
    com.netflix.eureka: INFO
    com.netflix.discovery: INFO
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} - %msg%n"
    file: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"
