version: '3.8'

services:
  eureka-server:
    build:
      context: ./eureka-server
    container_name: eureka-server
    ports:
      - "8761:8761"
    networks:
      - social-network

  api-gateway:
    build:
      context: ./api-gateway
    container_name: api-gateway
    ports:
      - "8082:8082"
    environment:
      - EUREKA_CLIENT_SERVICE_URL_DEFAULT_ZONE=http://eureka-server:8761/eureka/
      - KEYCLOAK_ISSUER_URI=http://keycloak:8080/realms/social-network
      - KEYCLOAK_CLIENT_ID=api-gateway
      - KEYCLOAK_CLIENT_SECRET=${KEYCLOAK_CLIENT_SECRET}
      - SIGNATURE_KEY_SECRET=${SIGNATURE_KEY_SECRET}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - REDIS_TIMEOUT=${REDIS_TIMEOUT}
      - HOSTNAME=api-gateway
      - SPRING_PROFILES_ACTIVE=prod
    depends_on:
      eureka-server:
        condition: service_started
      keycloak:
        condition: service_started
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8082/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - social-network

  redis:
    image: redis:7-alpine
    container_name: redis
    ports:
      - "6379:6379"
    command: redis-server --maxmemory 128mb --maxmemory-policy allkeys-lru
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.5'
        reservations:
          memory: 128M
          cpus: '0.25'
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - social-network

  minio:
    image:  quay.io/minio/minio:latest
    container_name: minio
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - minio_data:/data
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:9000/minio/health/live" ]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - social-network

  user-profile-service:
    build:
      context: ./user-profile-service
      dockerfile: Dockerfile
    container_name: user-profile-service
    ports:
      - "8081:8080"
    environment:
      SPRING_PROFILES_ACTIVE: dev
      JAVA_OPTS: "-Xms256m -Xmx512m"
      EUREKA_CLIENT_SERVICE_URL_DEFAULT_ZONE: http://eureka-server:8761/eureka/
      REDIS_HOST: ${REDIS_HOST}
      SIGNATURE_KEY_SECRET: ${SIGNATURE_KEY_SECRET}
      REDIS_PORT: ${REDIS_PORT}
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      REDIS_TIMEOUT: ${REDIS_TIMEOUT}
      SPRING_KAFKA_BOOTSTRAP_SERVERS: ${KAFKA_BOOTSTRAP_SERVERS_INTERNAL}
    depends_on:
      user-profile-postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      eureka-server:
        condition: service_started
      kafka:
        condition: service_started
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8080/api/user-profile/actuator/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - social-network

  upload-service:
    build:
      context: ./upload-service
      dockerfile: Dockerfile
    container_name: upload-service
    ports:
      - "8084:8084"
    environment:
      SPRING_PROFILES_ACTIVE: dev
      JAVA_OPTS: "-Xms256m -Xmx512m"
      EUREKA_CLIENT_SERVICE_URL_DEFAULT_ZONE: http://eureka-server:8761/eureka/
      MINIO_ENDPOINT: http://minio:9000
      MINIO_ACCESS_KEY: minioadmin
      MINIO_SECRET_KEY: minioadmin
      MINIO_BUCKET_NAME: media
      MINIO_PUBLIC_URL: http://localhost:9000/media
      SIGNATURE_KEY_SECRET: ${SIGNATURE_KEY_SECRET}
      SPRING_KAFKA_BOOTSTRAP_SERVERS: ${KAFKA_BOOTSTRAP_SERVERS_INTERNAL}
    depends_on:
      upload-postgres:
        condition: service_healthy
      minio:
        condition: service_healthy
      eureka-server:
        condition: service_started
      kafka:
        condition: service_started
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8084/api/upload/actuator/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - social-network

  upload-postgres:
    image: postgres:17-alpine
    container_name: upload-postgres
    environment:
      POSTGRES_USER: upload
      POSTGRES_PASSWORD: upload
      POSTGRES_DB: upload
    volumes:
      - ./infrastructure/databases/upload:/docker-entrypoint-initdb.d:ro
    ports:
      - "5440:5432"
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U upload -d upload" ]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - social-network

  user-profile-postgres:
    image: postgres:17-alpine
    container_name: user-profile-postgres
    environment:
      POSTGRES_USER: user-profile
      POSTGRES_PASSWORD: user-profile
      POSTGRES_DB: user_profile
    volumes:
      - ./infrastructure/databases/user-profile:/docker-entrypoint-initdb.d:ro
    ports:
      - "5438:5432"
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U user-profile -d user_profile" ]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - social-network

  relationship-postgres:
    image: postgres:17-alpine
    container_name: relationship-postgres
    environment:
      POSTGRES_USER: relationship
      POSTGRES_PASSWORD: relationship
      POSTGRES_DB: relationship
      POSTGRES_SHARED_BUFFERS: 64MB
      POSTGRES_EFFECTIVE_CACHE_SIZE: 128MB
    volumes:
      - ./infrastructure/databases/relationship:/docker-entrypoint-initdb.d:ro
    ports:
      - "5437:5432"
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.5'
        reservations:
          memory: 128M
          cpus: '0.25'
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U relationship -d relationship" ]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - social-network

  feed-postgres:
    image: postgres:17-alpine
    container_name: feed-postgres
    environment:
      POSTGRES_USER: feed
      POSTGRES_PASSWORD: feed
      POSTGRES_DB: feed
      POSTGRES_SHARED_BUFFERS: 64MB
      POSTGRES_EFFECTIVE_CACHE_SIZE: 128MB
    volumes:
      - ./infrastructure/databases/feed:/docker-entrypoint-initdb.d:ro
    ports:
      - "5435:5432"
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.5'
        reservations:
          memory: 128M
          cpus: '0.25'
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U feed -d feed" ]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - social-network

  messaging-postgres:
    image: postgres:17-alpine
    container_name: messaging-postgres
    environment:
      POSTGRES_USER: messaging
      POSTGRES_PASSWORD: messaging
      POSTGRES_DB: messaging
      POSTGRES_SHARED_BUFFERS: 96MB
      POSTGRES_EFFECTIVE_CACHE_SIZE: 192MB
    volumes:
      - ./infrastructure/databases/messaging:/docker-entrypoint-initdb.d:ro
    ports:
      - "5434:5432"
    deploy:
      resources:
        limits:
          memory: 384M
          cpus: '0.75'
        reservations:
          memory: 192M
          cpus: '0.375'
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U messaging -d messaging" ]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - social-network

  notification-postgres:
    image: postgres:17-alpine
    container_name: notification-postgres
    environment:
      POSTGRES_USER: notification
      POSTGRES_PASSWORD: notification
      POSTGRES_DB: notification
      POSTGRES_SHARED_BUFFERS: 32MB
      POSTGRES_EFFECTIVE_CACHE_SIZE: 64MB
    volumes:
      - ./infrastructure/databases/notification:/docker-entrypoint-initdb.d:ro
    ports:
      - "5433:5432"
    deploy:
      resources:
        limits:
          memory: 128M
          cpus: '0.25'
        reservations:
          memory: 64M
          cpus: '0.125'
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U notification -d notification" ]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - social-network

  keycloak-postgres:
    image: postgres:17-alpine
    container_name: keycloak-postgres
    environment:
      POSTGRES_USER: keycloak
      POSTGRES_PASSWORD: keycloak
      POSTGRES_DB: keycloak
      POSTGRES_SHARED_BUFFERS: 128MB
      POSTGRES_EFFECTIVE_CACHE_SIZE: 256MB
    ports:
      - "5431:5432"
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '1.0'
        reservations:
          memory: 256M
          cpus: '0.5'
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U keycloak -d keycloak" ]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - social-network

  user-profile-postgres-exporter:
    image: prometheuscommunity/postgres-exporter:latest
    container_name: user-profile-postgres-exporter
    depends_on:
      user-profile-postgres:
        condition: service_healthy
    environment:
      DATA_SOURCE_NAME: "postgresql://user-profile:user-profile@user-profile-postgres:5432/user_profile?sslmode=disable"
    ports:
      - "9181:9187"
    healthcheck:
      test: [ "CMD", "wget", "--spider", "-q", "http://localhost:9187/metrics" ]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - social-network

  upload-postgres-exporter:
    image: prometheuscommunity/postgres-exporter:latest
    container_name: upload-postgres-exporter
    depends_on:
      upload-postgres:
        condition: service_healthy
    environment:
      DATA_SOURCE_NAME: "postgresql://upload:upload@upload-postgres:5432/upload?sslmode=disable"
    ports:
      - "9188:9187"
    healthcheck:
      test: [ "CMD", "wget", "--spider", "-q", "http://localhost:9187/metrics" ]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - social-network

  relationship-postgres-exporter:
    image: prometheuscommunity/postgres-exporter:latest
    container_name: relationship-postgres-exporter
    depends_on:
      relationship-postgres:
        condition: service_healthy
    environment:
      DATA_SOURCE_NAME: "postgresql://relationship:relationship@relationship-postgres:5432/relationship?sslmode=disable"
    ports:
      - "9183:9187"
    deploy:
      resources:
        limits:
          memory: 64M
          cpus: '0.1'
        reservations:
          memory: 32M
          cpus: '0.05'
    networks:
      - social-network

  feed-postgres-exporter:
    image: prometheuscommunity/postgres-exporter:latest
    container_name: feed-postgres-exporter
    depends_on:
      feed-postgres:
        condition: service_healthy
    environment:
      DATA_SOURCE_NAME: "postgresql://feed:feed@feed-postgres:5432/feed?sslmode=disable"
    ports:
      - "9184:9187"
    deploy:
      resources:
        limits:
          memory: 64M
          cpus: '0.1'
        reservations:
          memory: 32M
          cpus: '0.05'
    networks:
      - social-network

  messaging-postgres-exporter:
    image: prometheuscommunity/postgres-exporter:latest
    container_name: messaging-postgres-exporter
    depends_on:
      messaging-postgres:
        condition: service_healthy
    environment:
      DATA_SOURCE_NAME: "postgresql://messaging:messaging@messaging-postgres:5432/messaging?sslmode=disable"
    ports:
      - "9185:9187"
    deploy:
      resources:
        limits:
          memory: 64M
          cpus: '0.1'
        reservations:
          memory: 32M
          cpus: '0.05'
    networks:
      - social-network

  notification-postgres-exporter:
    image: prometheuscommunity/postgres-exporter:latest
    container_name: notification-postgres-exporter
    depends_on:
      notification-postgres:
        condition: service_healthy
    environment:
      DATA_SOURCE_NAME: "postgresql://notification:notification@notification-postgres:5432/notification?sslmode=disable"
    ports:
      - "9186:9187"
    deploy:
      resources:
        limits:
          memory: 64M
          cpus: '0.1'
        reservations:
          memory: 32M
          cpus: '0.05'
    networks:
      - social-network

  keycloak-postgres-exporter:
    image: prometheuscommunity/postgres-exporter:latest
    container_name: keycloak-postgres-exporter
    depends_on:
      keycloak-postgres:
        condition: service_healthy
    environment:
      DATA_SOURCE_NAME: "postgresql://keycloak:keycloak@keycloak-postgres:5432/keycloak?sslmode=disable"
    ports:
      - "9187:9187"
    deploy:
      resources:
        limits:
          memory: 64M
          cpus: '0.1'
        reservations:
          memory: 32M
          cpus: '0.05'
    networks:
      - social-network

  keycloak:
    image: quay.io/keycloak/keycloak:26.2
    container_name: individuals-keycloak
    command:
      - start-dev
      - --import-realm
      - --health-enabled=true
      - --spi-email-sender-default-provider=smtp
    ports:
      - "8080:8080"
    environment:
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://keycloak-postgres:5432/keycloak
      KC_DB_USERNAME: keycloak
      KC_DB_PASSWORD: keycloak
      KC_METRICS_ENABLED: "true"
      KC_HEALTH_ENABLED: "true"
      KC_HOSTNAME: keycloak
      KC_HOSTNAME_STRICT: "false"
      KC_HOSTNAME_STRICT_BACKCHANNEL: "false"
      KC_SMTP_HOST: maildev
      KC_SMTP_PORT: 1025
      KC_SMTP_FROM: noreply@socialnetwork.com
      KC_SMTP_FROM_DISPLAY_NAME: "Social Network"
      KC_SMTP_AUTH: "false"
      KC_SMTP_SSL: "false"
      KC_SMTP_STARTTLS: "false"
      KC_HOSTNAME_STRICT_HTTPS: "false"
      KC_HTTP_ENABLED: "true"
      JAVA_OPTS: "-Xms256m -Xmx512m -XX:MaxMetaspaceSize=256m"
    volumes:
      - ./infrastructure/keycloak/realm-config.json:/opt/keycloak/data/import/realm-config.json
    depends_on:
      keycloak-postgres:
        condition: service_healthy
      maildev:
        condition: service_started
    deploy:
      resources:
        limits:
          memory: 768M
          cpus: '1.5'
        reservations:
          memory: 512M
          cpus: '1.0'
    healthcheck:
      test: [ "CMD-SHELL", "cat /proc/net/tcp 2>/dev/null | grep -q ':901F' || cat /proc/net/tcp 2>/dev/null | grep -q '00000000:901F' || exit 1" ]
      interval: 10s
      timeout: 5s
      retries: 30
      start_period: 60s
    networks:
      - social-network

  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./infrastructure/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--web.enable-lifecycle'
      - '--storage.tsdb.retention.time=7d'
      - '--storage.tsdb.retention.size=2GB'
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '1.0'
        reservations:
          memory: 256M
          cpus: '0.5'
    healthcheck:
      test: [ "CMD", "wget", "--spider", "-q", "http://localhost:9090/-/healthy" ]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - social-network

  loki:
    image: grafana/loki:2.9.2
    container_name: loki
    ports:
      - "3100:3100"
    command: -config.file=/etc/loki/loki-config.yaml
    volumes:
      - ./infrastructure/loki/loki-config.yaml:/etc/loki/loki-config.yaml
    deploy:
      resources:
        limits:
          memory: 384M
          cpus: '0.75'
        reservations:
          memory: 192M
          cpus: '0.375'
    healthcheck:
      test: [ "CMD", "wget", "--spider", "-q", "http://localhost:3100/ready" ]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - social-network

  tempo:
    image: grafana/tempo:2.4.1
    container_name: tempo
    command: [ "-config.file=/etc/tempo/tempo.yaml" ]
    volumes:
      - ./infrastructure/tempo/tempo.yaml:/etc/tempo/tempo.yaml
      - tempo_data:/tmp/tempo
    ports:
      - "3200:3200"
      - "9411:9411"
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.5'
        reservations:
          memory: 128M
          cpus: '0.25'
    healthcheck:
      test: [ "CMD", "wget", "--spider", "-q", "http://localhost:3200/ready" ]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - social-network

  alloy:
    image: grafana/alloy:latest
    container_name: alloy
    ports:
      - "9080:9080"
      - "4317:4317"
      - "4318:4318"
    volumes:
      - ./infrastructure/alloy/config.alloy:/etc/alloy/config.alloy:ro
      - /var/run/docker.sock:/var/run/docker.sock
    command:
      - run
      - --server.http.listen-addr=0.0.0.0:9080
      - --storage.path=/var/lib/alloy/data
      - /etc/alloy/config.alloy
    deploy:
      resources:
        limits:
          memory: 128M
          cpus: '0.25'
        reservations:
          memory: 64M
          cpus: '0.125'
    healthcheck:
      test: [ "CMD", "wget", "--spider", "-q", "http://localhost:9080/ready" ]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - social-network

  grafana:
    image: grafana/grafana:10.3.1
    container_name: grafana
    ports:
      - "3000:3000"
    environment:
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: admin
      GF_FEATURE_TOGGLES_ENABLE: "publicDashboards"
    volumes:
      - ./infrastructure/grafana/provisioning:/etc/grafana/provisioning
      - ./infrastructure/grafana/dashboards:/var/lib/grafana/dashboards
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.5'
        reservations:
          memory: 128M
          cpus: '0.25'
    healthcheck:
      test: [ "CMD", "wget", "--spider", "-q", "http://localhost:3000/api/health" ]
      interval: 10s
      timeout: 5s
      retries: 10
    networks:
      - social-network

  maildev:
    image: maildev/maildev
    container_name: maildev
    ports:
      - "1080:1080"
      - "1025:1025"
    deploy:
      resources:
        limits:
          memory: 128M
          cpus: '0.25'
        reservations:
          memory: 64M
          cpus: '0.125'
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:1080" ]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - social-network

  kafka:
    container_name: kafka
    image: apache/kafka:latest
    hostname: kafka
    restart: unless-stopped
    ports:
      - "9092:9092"
    environment:
      KAFKA_KRAFT_MODE: ${KAFKA_KRAFT_MODE}
      KAFKA_PROCESS_ROLES: ${KAFKA_PROCESS_ROLES}
      KAFKA_NODE_ID: ${KAFKA_NODE_ID}
      KAFKA_CONTROLLER_QUORUM_VOTERS: ${KAFKA_CONTROLLER_QUORUM_VOTERS}
      KAFKA_LISTENERS: ${KAFKA_LISTENERS}
      KAFKA_ADVERTISED_LISTENERS: ${KAFKA_ADVERTISED_LISTENERS}
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: ${KAFKA_LISTENER_SECURITY_PROTOCOL_MAP}
      KAFKA_INTER_BROKER_LISTENER_NAME: ${KAFKA_INTER_BROKER_LISTENER_NAME}
      KAFKA_CONTROLLER_LISTENER_NAMES: ${KAFKA_CONTROLLER_LISTENER_NAMES}
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: ${KAFKA_AUTO_CREATE_TOPICS_ENABLE}
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: ${KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR}
      KAFKA_NUM_PARTITIONS: ${KAFKA_NUM_PARTITIONS}
      KAFKA_BOOTSTRAP_SERVERS: ${KAFKA_BOOTSTRAP_SERVERS_INTERNAL}
    volumes:
      - kafka_data:/kafka/data
    networks:
      - social-network

  content-service:
    build:
      context: ./content-service
      dockerfile: Dockerfile
    container_name: content-service
    ports:
      - "${CONTENT_SERVICE_PORT:-8083}:8083"
    environment:
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE:-dev}
      JAVA_OPTS: "-Xms256m -Xmx512m"
      EUREKA_CLIENT_SERVICE_URL_DEFAULT_ZONE: ${EUREKA_CLIENT_SERVICE_URL_DEFAULT_ZONE:-http://eureka-server:8761/eureka/}
      SPRING_KAFKA_BOOTSTRAP_SERVERS: ${KAFKA_BOOTSTRAP_SERVERS_INTERNAL:-kafka:29092}
      CONTENT_DB_URL: ${CONTENT_DB_URL:-jdbc:postgresql://content-postgres:5432/content}
      REDIS_HOST: ${REDIS_HOST}
      SIGNATURE_KEY_SECRET: ${SIGNATURE_KEY_SECRET}
      REDIS_PORT: ${REDIS_PORT}
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      REDIS_TIMEOUT: ${REDIS_TIMEOUT}
      CONTENT_DB_USERNAME: ${CONTENT_DB_USERNAME:-content}
      CONTENT_DB_PASSWORD: ${CONTENT_DB_PASSWORD:-content}
      EUREKA_INSTANCE_HOSTNAME: ${EUREKA_INSTANCE_HOSTNAME:-content-service}
    depends_on:
      redis:
        condition: service_healthy
      content-postgres:
        condition: service_healthy
      eureka-server:
        condition: service_started
      kafka:
        condition: service_started
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8083/api/content/actuator/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - social-network

  content-postgres:
    image: postgres:17-alpine
    container_name: content-postgres
    environment:
      POSTGRES_USER: ${CONTENT_DB_USERNAME:-content}
      POSTGRES_PASSWORD: ${CONTENT_DB_PASSWORD:-content}
      POSTGRES_DB: content
      POSTGRES_SHARED_BUFFERS: 128MB
      POSTGRES_EFFECTIVE_CACHE_SIZE: 256MB
    volumes:
      - ./infrastructure/databases/content:/docker-entrypoint-initdb.d:ro
    ports:
      - "${CONTENT_DB_EXTERNAL_PORT:-5436}:5432"
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '1.0'
        reservations:
          memory: 256M
          cpus: '0.5'
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${CONTENT_DB_USERNAME:-content} -d content" ]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - social-network

  content-postgres-exporter:
    image: prometheuscommunity/postgres-exporter:latest
    container_name: content-postgres-exporter
    depends_on:
      content-postgres:
        condition: service_healthy
    environment:
      DATA_SOURCE_NAME: "postgresql://${CONTENT_DB_USERNAME:-content}:${CONTENT_DB_PASSWORD:-content}@content-postgres:5432/content?sslmode=disable"
    ports:
      - "${CONTENT_POSTGRES_EXPORTER_PORT:-9182}:9187"
    deploy:
      resources:
        limits:
          memory: 64M
          cpus: '0.1'
        reservations:
          memory: 32M
          cpus: '0.05'
    networks:
      - social-network

volumes:
  tempo_data:
  minio_data:
  kafka_data:

networks:
  social-network:
    driver: bridge